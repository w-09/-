<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南一處-亞灣工務所進度分析圖表</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auto-sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin: 30px 0;
        }
        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .control-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            margin: 0 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .data-table {
            margin: 20px 0;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .status-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-ahead {
            background: #d4edda;
            color: #155724;
        }
        .status-normal {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-behind {
            background: #f8d7da;
            color: #721c24;
        }
        .sync-log {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .sync-log h4 {
            margin-top: 0;
            color: #007bff;
        }
        .log-entry {
            font-size: 12px;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-success {
            color: #28a745;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #17a2b8;
        }
        .update-timestamp {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin: 10px 0;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .summary-card.income {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .summary-card.expense {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }
        .summary-card.profit {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .summary-card .amount {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="auto-sync-indicator" id="syncIndicator">
        🔄 自動同步中... <span id="nextUpdateIn">30</span>s
    </div>

    <div class="container">
        <h1>💰 亞灣工務所金流分析系統</h1>
        <div class="update-timestamp">
            資料來源: Google Sheets | 最後更新: <span id="lastUpdate">載入中...</span>
        </div>

        <div class="summary-cards">
            <div class="summary-card income">
                <h3>💵 總實際收入</h3>
                <div class="amount" id="totalActual">載入中...</div>
            </div>
            <div class="summary-card expense">
                <h3>💸 總實際支出</h3>
                <div class="amount" id="totalExpense">載入中...</div>
            </div>
            <div class="summary-card">
                <h3>📋 總預算金額</h3>
                <div class="amount" id="totalPlanned">載入中...</div>
            </div>
            <div class="summary-card profit">
                <h3>💰 淨收益</h3>
                <div class="amount" id="netProfit">載入中...</div>
            </div>
            <div class="summary-card">
                <h3>📊 收支差異</h3>
                <div class="amount" id="totalDifference">載入中...</div>
            </div>
            <div class="summary-card">
                <h3>📈 執行率</h3>
                <div class="amount" id="executionRate">載入中...</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>圖表類型選擇:</label>
                <select id="chartType" onchange="updateChart()">
                    <option value="bar">柱狀圖</option>
                    <option value="line">線圖</option>
                    <option value="radar">雷達圖</option>
                </select>
            </div>
            <div class="control-group">
                <label>顯示數據:</label>
                <input type="checkbox" id="showActual" checked onchange="updateChart()"> 實際收入
                <input type="checkbox" id="showExpense" checked onchange="updateChart()"> 實際支出
                <input type="checkbox" id="showPlanned" checked onchange="updateChart()"> 預算金額
                <input type="checkbox" id="showDifference" onchange="updateChart()"> 差異
                <input type="checkbox" id="showNetProfit" onchange="updateChart()"> 淨收益
            </div>
            <div class="control-group">
                <button onclick="manualSync()">手動同步</button>
                <button onclick="exportChart()">匯出圖表</button>
                <button onclick="exportData()">匯出數據</button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="differenceChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="profitChart"></canvas>
        </div>

        <div class="data-table">
            <h3>💰 詳細金流表 <span id="dataCount">(載入中...)</span></h3>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>項目名稱</th>
                        <th>實際收入 (元)</th>
                        <th>實際支出 (元)</th>
                        <th>預算金額 (元)</th>
                        <th>淨收益 (元)</th>
                        <th>收支差異 (元)</th>
                        <th>執行率</th>
                        <th>狀態</th>
                        <th>趨勢</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="sync-log">
            <h4>📋 同步記錄</h4>
            <div id="syncLogContent">
                <div class="log-entry log-info">系統啟動中...</div>
            </div>
        </div>
    </div>
    <script>
    // 配置設定
    const CONFIG = {
        SHEETS_ID: '1jpcMCUcpveh7-doxSdHNP6wK5NuxsMvc3-A5Il42Enk',
        SYNC_INTERVAL: 30000,
        MAX_LOG_ENTRIES: 20
    };

    // 全域變數
    let projectData = [];
    let previousData = [];
    let progressChart, differenceChart, profitChart;
    let syncInterval = null;
    let countdownInterval = null;
    let nextUpdateCountdown = 30;

    const SHEETS_CSV_URL = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEETS_ID}/export?format=csv&gid=0`;

    // 格式化函數
    function formatCurrency(amount) {
    return new Intl.NumberFormat('zh-TW', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount) + ' 元';
}

    function formatNumber(number) {
        return new Intl.NumberFormat('zh-TW').format(number);
    }

    // 系統初始化
    async function initSystem() {
        addLogEntry('🚀 系統初始化中...', 'info');
        
        try {
            await initCharts();
            await loadSampleData();
            startAutoSync();
            startCountdown();
            
            addLogEntry('✅ 系統初始化完成，自動同步已啟動', 'success');
        } catch (error) {
            addLogEntry('❌ 系統初始化失敗: ' + error.message, 'error');
        }
    }

    // 載入示例數據
    function loadSampleData() {
        projectData = [
            {
                name: '亞灣區開發案A',
                actual: 15000000,
                expense: 12000000,
                planned: 14000000,
                difference: 1000000,
                netProfit: 3000000,
                executionRate: 107.14,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: '亞灣區開發案B',
                actual: 8500000,
                expense: 7200000,
                planned: 9000000,
                difference: -500000,
                netProfit: 1300000,
                executionRate: 94.44,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: '亞灣區開發案C',
                actual: 22000000,
                expense: 18500000,
                planned: 20000000,
                difference: 2000000,
                netProfit: 3500000,
                executionRate: 110.00,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: '亞灣區開發案D',
                actual: 6800000,
                expense: 7500000,
                planned: 7500000,
                difference: -700000,
                netProfit: -700000,
                executionRate: 90.67,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: '亞灣區開發案E',
                actual: 12300000,
                expense: 9800000,
                planned: 11000000,
                difference: 1300000,
                netProfit: 2500000,
                executionRate: 111.82,
                lastUpdate: new Date().toLocaleString()
            }
        ];
        
        updateChart();
        updateTable();
        updateSummaryCards();
        updateLastUpdateTime();
        
        addLogEntry('✅ 示例數據載入完成', 'success');
    }

    // 圖表初始化
    async function initCharts() {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 1000, easing: 'easeInOutQuart' },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: '金額 (新台幣)' },
                    ticks: { callback: function(value) { return formatCurrency(value); } }
                }
            }
        };

        const ctx1 = document.getElementById('progressChart').getContext('2d');
        progressChart = new Chart(ctx1, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                ...chartOptions,
                plugins: {
                    title: { display: true, text: '💰 金流比較 - 收入 vs 支出 vs 預算', font: { size: 16 } },
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });

        const ctx2 = document.getElementById('differenceChart').getContext('2d');
        differenceChart = new Chart(ctx2, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                ...chartOptions,
                plugins: {
                    title: { display: true, text: '📊 收支差異分析 (負值=不足，正值=超出)', font: { size: 16 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '差異: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: '差異金額 (新台幣)' },
                        ticks: { callback: function(value) { return formatCurrency(value); } }
                    }
                }
            }
        });

        const ctx3 = document.getElementById('profitChart').getContext('2d');
        profitChart = new Chart(ctx3, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                ...chartOptions,
                plugins: {
                    title: { display: true, text: '💰 淨收益分析 (收入 - 支出)', font: { size: 16 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '淨收益: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: '淨收益 (新台幣)' },
                        ticks: { callback: function(value) { return formatCurrency(value); } }
                    }
                }
            }
        });
    }
        // 數據同步功能
    async function performSync() {
        try {
            addLogEntry('🔄 開始從Google Sheets同步數據...', 'info');
            
            const response = await fetch(SHEETS_CSV_URL);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const csvText = await response.text();
            const newData = parseCSV(csvText);
            
            if (newData.length === 0) {
                addLogEntry('⚠️ 未找到有效數據，使用示例數據', 'info');
                return;
            }

            const hasChanges = detectChanges(newData);
            previousData = [...projectData];
            projectData = newData;
            
            updateChart();
            updateTable();
            updateSummaryCards();
            updateLastUpdateTime();
            
            const changeInfo = hasChanges ? ` (檢測到 ${hasChanges} 項變更)` : ' (無變更)';
            addLogEntry(`✅ 同步成功: 載入 ${newData.length} 筆數據${changeInfo}`, 'success');
            
        } catch (error) {
            addLogEntry('❌ 同步失敗: ' + error.message + ' (使用示例數據)', 'error');
            console.error('同步錯誤:', error);
        }
    }

    // CSV 解析
    function parseCSV(csvText) {
        const lines = csvText.split('\n');
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const columns = parseCSVLine(line);
            if (columns.length >= 4) {
                const name = columns[0].replace(/"/g, '').trim();
                const actual = parseFloat(columns[1]) || 0;
                const expense = parseFloat(columns[2]) || 0;
                const planned = parseFloat(columns[3]) || 0;
                const difference = actual - planned;
                const netProfit = actual - expense;
                
                if (name && name !== '') {
                    data.push({
                        name: name,
                        actual: actual,
                        expense: expense,
                        planned: planned,
                        difference: difference,
                        netProfit: netProfit,
                        executionRate: planned > 0 ? (actual / planned * 100) : 0,
                        lastUpdate: new Date().toLocaleString()
                    });
                }
            }
        }
        
        return data;
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current);
        return result;
    }

    // 變更檢測
    function detectChanges(newData) {
        if (previousData.length === 0) return 0;
        
        let changes = 0;
        newData.forEach(newItem => {
            const oldItem = previousData.find(item => item.name === newItem.name);
            if (!oldItem) {
                changes++;
            } else if (
                oldItem.actual !== newItem.actual || 
                oldItem.expense !== newItem.expense ||
                oldItem.planned !== newItem.planned
            ) {
                changes++;
            }
        });
        
        return changes;
    }

    // 更新摘要卡片
    function updateSummaryCards() {
        const totalActual = projectData.reduce((sum, item) => sum + item.actual, 0);
        const totalExpense = projectData.reduce((sum, item) => sum + item.expense, 0);
        const totalPlanned = projectData.reduce((sum, item) => sum + item.planned, 0);
        const totalDifference = totalActual - totalPlanned;
        const netProfit = totalActual - totalExpense;
        const executionRate = totalPlanned > 0 ? (totalActual / totalPlanned * 100) : 0;

        document.getElementById('totalActual').textContent = formatCurrency(totalActual);
        document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
        document.getElementById('totalPlanned').textContent = formatCurrency(totalPlanned);
        document.getElementById('totalDifference').textContent = formatCurrency(totalDifference);
        document.getElementById('netProfit').textContent = formatCurrency(netProfit);
        document.getElementById('executionRate').textContent = executionRate.toFixed(1) + '%';
    }

    // 自動同步控制
    function startAutoSync() {
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(performSync, CONFIG.SYNC_INTERVAL);
        performSync(); // 立即執行一次
    }

    function stopAutoSync() {
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }
    }

    // 倒數計時器
    function startCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        
        countdownInterval = setInterval(() => {
            nextUpdateCountdown--;
            document.getElementById('nextUpdateIn').textContent = nextUpdateCountdown;
            
            if (nextUpdateCountdown <= 0) {
                nextUpdateCountdown = 30; // 重置倒數
            }
        }, 1000);
    }

    // 手動同步
    function manualSync() {
        nextUpdateCountdown = 30; // 重置倒數
        performSync();
        addLogEntry('🔄 手動同步已觸發', 'info');
    }

    // 日誌管理
    function addLogEntry(message, type = 'info') {
        const logContent = document.getElementById('syncLogContent');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
        
        logContent.insertBefore(entry, logContent.firstChild);
        
        // 限制日誌條目數量
        const entries = logContent.querySelectorAll('.log-entry');
        if (entries.length > CONFIG.MAX_LOG_ENTRIES) {
            logContent.removeChild(entries[entries.length - 1]);
        }
    }

    // 更新最後更新時間
    function updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
    }
        // 圖表更新功能
    function updateChart() {
        const chartType = document.getElementById('chartType').value;
        const showActual = document.getElementById('showActual').checked;
        const showExpense = document.getElementById('showExpense').checked;
        const showPlanned = document.getElementById('showPlanned').checked;
        const showDifference = document.getElementById('showDifference').checked;
        const showNetProfit = document.getElementById('showNetProfit').checked;

        const labels = projectData.map(item => item.name);
        const datasets = [];

        // 主要圖表數據集
        if (showActual) {
            datasets.push({
                label: '實際收入',
                data: projectData.map(item => item.actual),
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2
            });
        }

        if (showExpense) {
            datasets.push({
                label: '實際支出',
                data: projectData.map(item => item.expense),
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 2
            });
        }

        if (showPlanned) {
            datasets.push({
                label: '預算金額',
                data: projectData.map(item => item.planned),
                backgroundColor: 'rgba(0, 123, 255, 0.8)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 2
            });
        }

        if (showNetProfit) {
            datasets.push({
                label: '淨收益',
                data: projectData.map(item => item.netProfit),
                backgroundColor: 'rgba(111, 66, 193, 0.8)',
                borderColor: 'rgba(111, 66, 193, 1)',
                borderWidth: 2
            });
        }

        // 更新主要圖表
        progressChart.data.labels = labels;
        progressChart.data.datasets = datasets;
        progressChart.config.type = chartType;
        progressChart.update();

        // 更新差異圖表
        const differenceData = projectData.map(item => item.difference);
        const differenceColors = differenceData.map(value => 
            value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
        );

        differenceChart.data.labels = labels;
        differenceChart.data.datasets = [{
            label: '收支差異',
            data: differenceData,
            backgroundColor: differenceColors,
            borderColor: differenceColors.map(color => color.replace('0.8', '1')),
            borderWidth: 2
        }];
        differenceChart.update();

        // 更新淨收益圖表
        const profitData = projectData.map(item => item.netProfit);
        const profitColors = profitData.map(value => 
            value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
        );

        profitChart.data.labels = labels;
        profitChart.data.datasets = [{
            label: '淨收益',
            data: profitData,
            backgroundColor: profitColors,
            borderColor: profitColors.map(color => color.replace('0.8', '1')),
            borderWidth: 2
        }];
        profitChart.update();
    }

    // 表格更新功能
    function updateTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        projectData.forEach((item, index) => {
            const row = document.createElement('tr');
            
            // 狀態判斷
            let status, statusClass;
            if (item.executionRate >= 105) {
                status = '超前';
                statusClass = 'status-ahead';
            } else if (item.executionRate >= 95) {
                status = '正常';
                statusClass = 'status-normal';
            } else {
                status = '落後';
                statusClass = 'status-behind';
            }

            // 趨勢分析
            let trend = '➡️';
            if (previousData.length > 0) {
                const prevItem = previousData.find(prev => prev.name === item.name);
                if (prevItem) {
                    if (item.actual > prevItem.actual) trend = '📈';
                    else if (item.actual < prevItem.actual) trend = '📉';
                }
            }

            row.innerHTML = `
                <td><strong>${item.name}</strong></td>
                <td class="positive">${formatCurrency(item.actual)}</td>
                <td class="negative">${formatCurrency(item.expense)}</td>
                <td>${formatCurrency(item.planned)}</td>
                <td class="${item.netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(item.netProfit)}</td>
                <td class="${item.difference >= 0 ? 'positive' : 'negative'}">${formatCurrency(item.difference)}</td>
                <td>${item.executionRate.toFixed(1)}%</td>
                <td><span class="status-indicator ${statusClass}">${status}</span></td>
                <td>${trend}</td>
            `;
            
            tableBody.appendChild(row);
        });

        document.getElementById('dataCount').textContent = `(${projectData.length} 個項目)`;
    }

    // 匯出功能
    function exportChart() {
        try {
            const canvas = document.getElementById('progressChart');
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `亞灣工務所金流分析_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = url;
            link.click();
            
            addLogEntry('📊 圖表匯出成功', 'success');
        } catch (error) {
            addLogEntry('❌ 圖表匯出失敗: ' + error.message, 'error');
        }
    }

    function exportData() {
        try {
            let csvContent = "項目名稱,實際收入,實際支出,預算金額,淨收益,收支差異,執行率,最後更新\n";
            
            projectData.forEach(item => {
                csvContent += `"${item.name}",${item.actual},${item.expense},${item.planned},${item.netProfit},${item.difference},${item.executionRate.toFixed(2)},${item.lastUpdate}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `亞灣工務所金流數據_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addLogEntry('📋 數據匯出成功', 'success');
        } catch (error) {
            addLogEntry('❌ 數據匯出失敗: ' + error.message, 'error');
        }
    }

    // 響應式設計支援
    function handleResize() {
        if (progressChart) progressChart.resize();
        if (differenceChart) differenceChart.resize();
        if (profitChart) profitChart.resize();
    }

    // 事件監聽器
    window.addEventListener('resize', handleResize);
    window.addEventListener('beforeunload', () => {
        stopAutoSync();
        if (countdownInterval) clearInterval(countdownInterval);
    });

    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', function() {
        initSystem();
        
        // 添加鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        manualSync();
                        break;
                    case 's':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'p':
                        e.preventDefault();
                        exportChart();
                        break;
                }
            }
        });
    });

</script>
</body>
</html>



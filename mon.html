<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—ä¸€è™•-äºç£å·¥å‹™æ‰€é€²åº¦åˆ†æåœ–è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auto-sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin: 30px 0;
        }
        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .control-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            margin: 0 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .data-table {
            margin: 20px 0;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .status-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-ahead {
            background: #d4edda;
            color: #155724;
        }
        .status-normal {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-behind {
            background: #f8d7da;
            color: #721c24;
        }
        .sync-log {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .sync-log h4 {
            margin-top: 0;
            color: #007bff;
        }
        .log-entry {
            font-size: 12px;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-success {
            color: #28a745;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #17a2b8;
        }
        .update-timestamp {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin: 10px 0;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .summary-card.income {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .summary-card.expense {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }
        .summary-card.profit {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .summary-card .amount {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="auto-sync-indicator" id="syncIndicator">
        ğŸ”„ è‡ªå‹•åŒæ­¥ä¸­... <span id="nextUpdateIn">30</span>s
    </div>

    <div class="container">
        <h1>ğŸ’° äºç£å·¥å‹™æ‰€é‡‘æµåˆ†æç³»çµ±</h1>
        <div class="update-timestamp">
            è³‡æ–™ä¾†æº: Google Sheets | æœ€å¾Œæ›´æ–°: <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="summary-cards">
            <div class="summary-card income">
                <h3>ğŸ’µ ç¸½å¯¦éš›æ”¶å…¥</h3>
                <div class="amount" id="totalActual">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="summary-card expense">
                <h3>ğŸ’¸ ç¸½å¯¦éš›æ”¯å‡º</h3>
                <div class="amount" id="totalExpense">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="summary-card">
                <h3>ğŸ“‹ ç¸½é ç®—é‡‘é¡</h3>
                <div class="amount" id="totalPlanned">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="summary-card profit">
                <h3>ğŸ’° æ·¨æ”¶ç›Š</h3>
                <div class="amount" id="netProfit">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="summary-card">
                <h3>ğŸ“Š æ”¶æ”¯å·®ç•°</h3>
                <div class="amount" id="totalDifference">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="summary-card">
                <h3>ğŸ“ˆ åŸ·è¡Œç‡</h3>
                <div class="amount" id="executionRate">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>åœ–è¡¨é¡å‹é¸æ“‡:</label>
                <select id="chartType" onchange="updateChart()">
                    <option value="bar">æŸ±ç‹€åœ–</option>
                    <option value="line">ç·šåœ–</option>
                    <option value="radar">é›·é”åœ–</option>
                </select>
            </div>
            <div class="control-group">
                <label>é¡¯ç¤ºæ•¸æ“š:</label>
                <input type="checkbox" id="showActual" checked onchange="updateChart()"> å¯¦éš›æ”¶å…¥
                <input type="checkbox" id="showExpense" checked onchange="updateChart()"> å¯¦éš›æ”¯å‡º
                <input type="checkbox" id="showPlanned" checked onchange="updateChart()"> é ç®—é‡‘é¡
                <input type="checkbox" id="showDifference" onchange="updateChart()"> å·®ç•°
                <input type="checkbox" id="showNetProfit" onchange="updateChart()"> æ·¨æ”¶ç›Š
            </div>
            <div class="control-group">
                <button onclick="manualSync()">æ‰‹å‹•åŒæ­¥</button>
                <button onclick="exportChart()">åŒ¯å‡ºåœ–è¡¨</button>
                <button onclick="exportData()">åŒ¯å‡ºæ•¸æ“š</button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="differenceChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="profitChart"></canvas>
        </div>

        <div class="data-table">
            <h3>ğŸ’° è©³ç´°é‡‘æµè¡¨ <span id="dataCount">(è¼‰å…¥ä¸­...)</span></h3>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>é …ç›®åç¨±</th>
                        <th>å¯¦éš›æ”¶å…¥ (å…ƒ)</th>
                        <th>å¯¦éš›æ”¯å‡º (å…ƒ)</th>
                        <th>é ç®—é‡‘é¡ (å…ƒ)</th>
                        <th>æ·¨æ”¶ç›Š (å…ƒ)</th>
                        <th>æ”¶æ”¯å·®ç•° (å…ƒ)</th>
                        <th>åŸ·è¡Œç‡</th>
                        <th>ç‹€æ…‹</th>
                        <th>è¶¨å‹¢</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="sync-log">
            <h4>ğŸ“‹ åŒæ­¥è¨˜éŒ„</h4>
            <div id="syncLogContent">
                <div class="log-entry log-info">ç³»çµ±å•Ÿå‹•ä¸­...</div>
            </div>
        </div>
    </div>
    <script>
    // é…ç½®è¨­å®š
    const CONFIG = {
        SHEETS_ID: '1jpcMCUcpveh7-doxSdHNP6wK5NuxsMvc3-A5Il42Enk',
        SYNC_INTERVAL: 30000,
        MAX_LOG_ENTRIES: 20
    };

    // å…¨åŸŸè®Šæ•¸
    let projectData = [];
    let previousData = [];
    let progressChart, differenceChart, profitChart;
    let syncInterval = null;
    let countdownInterval = null;
    let nextUpdateCountdown = 30;

    const SHEETS_CSV_URL = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEETS_ID}/export?format=csv&gid=0`;

    // æ ¼å¼åŒ–å‡½æ•¸
    function formatCurrency(amount) {
    return new Intl.NumberFormat('zh-TW', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount) + ' å…ƒ';
}

    function formatNumber(number) {
        return new Intl.NumberFormat('zh-TW').format(number);
    }

    // ç³»çµ±åˆå§‹åŒ–
    async function initSystem() {
        addLogEntry('ğŸš€ ç³»çµ±åˆå§‹åŒ–ä¸­...', 'info');
        
        try {
            await initCharts();
            await loadSampleData();
            startAutoSync();
            startCountdown();
            
            addLogEntry('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œè‡ªå‹•åŒæ­¥å·²å•Ÿå‹•', 'success');
        } catch (error) {
            addLogEntry('âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
        }
    }

    // è¼‰å…¥ç¤ºä¾‹æ•¸æ“š
    function loadSampleData() {
        projectData = [
            {
                name: 'äºç£å€é–‹ç™¼æ¡ˆA',
                actual: 15000000,
                expense: 12000000,
                planned: 14000000,
                difference: 1000000,
                netProfit: 3000000,
                executionRate: 107.14,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: 'äºç£å€é–‹ç™¼æ¡ˆB',
                actual: 8500000,
                expense: 7200000,
                planned: 9000000,
                difference: -500000,
                netProfit: 1300000,
                executionRate: 94.44,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: 'äºç£å€é–‹ç™¼æ¡ˆC',
                actual: 22000000,
                expense: 18500000,
                planned: 20000000,
                difference: 2000000,
                netProfit: 3500000,
                executionRate: 110.00,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: 'äºç£å€é–‹ç™¼æ¡ˆD',
                actual: 6800000,
                expense: 7500000,
                planned: 7500000,
                difference: -700000,
                netProfit: -700000,
                executionRate: 90.67,
                lastUpdate: new Date().toLocaleString()
            },
            {
                name: 'äºç£å€é–‹ç™¼æ¡ˆE',
                actual: 12300000,
                expense: 9800000,
                planned: 11000000,
                difference: 1300000,
                netProfit: 2500000,
                executionRate: 111.82,
                lastUpdate: new Date().toLocaleString()
            }
        ];
        
        updateChart();
        updateTable();
        updateSummaryCards();
        updateLastUpdateTime();
        
        addLogEntry('âœ… ç¤ºä¾‹æ•¸æ“šè¼‰å…¥å®Œæˆ', 'success');
    }

    // åœ–è¡¨åˆå§‹åŒ–
    async function initCharts() {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 1000, easing: 'easeInOutQuart' },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'é‡‘é¡ (æ–°å°å¹£)' },
                    ticks: { callback: function(value) { return formatCurrency(value); } }
                }
            }
        };

        const ctx1 = document.getElementById('progressChart').getContext('2d');
        progressChart = new Chart(ctx1, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                ...chartOptions,
                plugins: {
                    title: { display: true, text: 'ğŸ’° é‡‘æµæ¯”è¼ƒ - æ”¶å…¥ vs æ”¯å‡º vs é ç®—', font: { size: 16 } },
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });

        const ctx2 = document.getElementById('differenceChart').getContext('2d');
        differenceChart = new Chart(ctx2, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                ...chartOptions,
                plugins: {
                    title: { display: true, text: 'ğŸ“Š æ”¶æ”¯å·®ç•°åˆ†æ (è² å€¼=ä¸è¶³ï¼Œæ­£å€¼=è¶…å‡º)', font: { size: 16 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'å·®ç•°: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'å·®ç•°é‡‘é¡ (æ–°å°å¹£)' },
                        ticks: { callback: function(value) { return formatCurrency(value); } }
                    }
                }
            }
        });

        const ctx3 = document.getElementById('profitChart').getContext('2d');
        profitChart = new Chart(ctx3, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                ...chartOptions,
                plugins: {
                    title: { display: true, text: 'ğŸ’° æ·¨æ”¶ç›Šåˆ†æ (æ”¶å…¥ - æ”¯å‡º)', font: { size: 16 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'æ·¨æ”¶ç›Š: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'æ·¨æ”¶ç›Š (æ–°å°å¹£)' },
                        ticks: { callback: function(value) { return formatCurrency(value); } }
                    }
                }
            }
        });
    }
        // æ•¸æ“šåŒæ­¥åŠŸèƒ½
    async function performSync() {
        try {
            addLogEntry('ğŸ”„ é–‹å§‹å¾Google SheetsåŒæ­¥æ•¸æ“š...', 'info');
            
            const response = await fetch(SHEETS_CSV_URL);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const csvText = await response.text();
            const newData = parseCSV(csvText);
            
            if (newData.length === 0) {
                addLogEntry('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆæ•¸æ“šï¼Œä½¿ç”¨ç¤ºä¾‹æ•¸æ“š', 'info');
                return;
            }

            const hasChanges = detectChanges(newData);
            previousData = [...projectData];
            projectData = newData;
            
            updateChart();
            updateTable();
            updateSummaryCards();
            updateLastUpdateTime();
            
            const changeInfo = hasChanges ? ` (æª¢æ¸¬åˆ° ${hasChanges} é …è®Šæ›´)` : ' (ç„¡è®Šæ›´)';
            addLogEntry(`âœ… åŒæ­¥æˆåŠŸ: è¼‰å…¥ ${newData.length} ç­†æ•¸æ“š${changeInfo}`, 'success');
            
        } catch (error) {
            addLogEntry('âŒ åŒæ­¥å¤±æ•—: ' + error.message + ' (ä½¿ç”¨ç¤ºä¾‹æ•¸æ“š)', 'error');
            console.error('åŒæ­¥éŒ¯èª¤:', error);
        }
    }

    // CSV è§£æ
    function parseCSV(csvText) {
        const lines = csvText.split('\n');
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const columns = parseCSVLine(line);
            if (columns.length >= 4) {
                const name = columns[0].replace(/"/g, '').trim();
                const actual = parseFloat(columns[1]) || 0;
                const expense = parseFloat(columns[2]) || 0;
                const planned = parseFloat(columns[3]) || 0;
                const difference = actual - planned;
                const netProfit = actual - expense;
                
                if (name && name !== '') {
                    data.push({
                        name: name,
                        actual: actual,
                        expense: expense,
                        planned: planned,
                        difference: difference,
                        netProfit: netProfit,
                        executionRate: planned > 0 ? (actual / planned * 100) : 0,
                        lastUpdate: new Date().toLocaleString()
                    });
                }
            }
        }
        
        return data;
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current);
        return result;
    }

    // è®Šæ›´æª¢æ¸¬
    function detectChanges(newData) {
        if (previousData.length === 0) return 0;
        
        let changes = 0;
        newData.forEach(newItem => {
            const oldItem = previousData.find(item => item.name === newItem.name);
            if (!oldItem) {
                changes++;
            } else if (
                oldItem.actual !== newItem.actual || 
                oldItem.expense !== newItem.expense ||
                oldItem.planned !== newItem.planned
            ) {
                changes++;
            }
        });
        
        return changes;
    }

    // æ›´æ–°æ‘˜è¦å¡ç‰‡
    function updateSummaryCards() {
        const totalActual = projectData.reduce((sum, item) => sum + item.actual, 0);
        const totalExpense = projectData.reduce((sum, item) => sum + item.expense, 0);
        const totalPlanned = projectData.reduce((sum, item) => sum + item.planned, 0);
        const totalDifference = totalActual - totalPlanned;
        const netProfit = totalActual - totalExpense;
        const executionRate = totalPlanned > 0 ? (totalActual / totalPlanned * 100) : 0;

        document.getElementById('totalActual').textContent = formatCurrency(totalActual);
        document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
        document.getElementById('totalPlanned').textContent = formatCurrency(totalPlanned);
        document.getElementById('totalDifference').textContent = formatCurrency(totalDifference);
        document.getElementById('netProfit').textContent = formatCurrency(netProfit);
        document.getElementById('executionRate').textContent = executionRate.toFixed(1) + '%';
    }

    // è‡ªå‹•åŒæ­¥æ§åˆ¶
    function startAutoSync() {
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(performSync, CONFIG.SYNC_INTERVAL);
        performSync(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
    }

    function stopAutoSync() {
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }
    }

    // å€’æ•¸è¨ˆæ™‚å™¨
    function startCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        
        countdownInterval = setInterval(() => {
            nextUpdateCountdown--;
            document.getElementById('nextUpdateIn').textContent = nextUpdateCountdown;
            
            if (nextUpdateCountdown <= 0) {
                nextUpdateCountdown = 30; // é‡ç½®å€’æ•¸
            }
        }, 1000);
    }

    // æ‰‹å‹•åŒæ­¥
    function manualSync() {
        nextUpdateCountdown = 30; // é‡ç½®å€’æ•¸
        performSync();
        addLogEntry('ğŸ”„ æ‰‹å‹•åŒæ­¥å·²è§¸ç™¼', 'info');
    }

    // æ—¥èªŒç®¡ç†
    function addLogEntry(message, type = 'info') {
        const logContent = document.getElementById('syncLogContent');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
        
        logContent.insertBefore(entry, logContent.firstChild);
        
        // é™åˆ¶æ—¥èªŒæ¢ç›®æ•¸é‡
        const entries = logContent.querySelectorAll('.log-entry');
        if (entries.length > CONFIG.MAX_LOG_ENTRIES) {
            logContent.removeChild(entries[entries.length - 1]);
        }
    }

    // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
    function updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
    }
        // åœ–è¡¨æ›´æ–°åŠŸèƒ½
    function updateChart() {
        const chartType = document.getElementById('chartType').value;
        const showActual = document.getElementById('showActual').checked;
        const showExpense = document.getElementById('showExpense').checked;
        const showPlanned = document.getElementById('showPlanned').checked;
        const showDifference = document.getElementById('showDifference').checked;
        const showNetProfit = document.getElementById('showNetProfit').checked;

        const labels = projectData.map(item => item.name);
        const datasets = [];

        // ä¸»è¦åœ–è¡¨æ•¸æ“šé›†
        if (showActual) {
            datasets.push({
                label: 'å¯¦éš›æ”¶å…¥',
                data: projectData.map(item => item.actual),
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2
            });
        }

        if (showExpense) {
            datasets.push({
                label: 'å¯¦éš›æ”¯å‡º',
                data: projectData.map(item => item.expense),
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 2
            });
        }

        if (showPlanned) {
            datasets.push({
                label: 'é ç®—é‡‘é¡',
                data: projectData.map(item => item.planned),
                backgroundColor: 'rgba(0, 123, 255, 0.8)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 2
            });
        }

        if (showNetProfit) {
            datasets.push({
                label: 'æ·¨æ”¶ç›Š',
                data: projectData.map(item => item.netProfit),
                backgroundColor: 'rgba(111, 66, 193, 0.8)',
                borderColor: 'rgba(111, 66, 193, 1)',
                borderWidth: 2
            });
        }

        // æ›´æ–°ä¸»è¦åœ–è¡¨
        progressChart.data.labels = labels;
        progressChart.data.datasets = datasets;
        progressChart.config.type = chartType;
        progressChart.update();

        // æ›´æ–°å·®ç•°åœ–è¡¨
        const differenceData = projectData.map(item => item.difference);
        const differenceColors = differenceData.map(value => 
            value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
        );

        differenceChart.data.labels = labels;
        differenceChart.data.datasets = [{
            label: 'æ”¶æ”¯å·®ç•°',
            data: differenceData,
            backgroundColor: differenceColors,
            borderColor: differenceColors.map(color => color.replace('0.8', '1')),
            borderWidth: 2
        }];
        differenceChart.update();

        // æ›´æ–°æ·¨æ”¶ç›Šåœ–è¡¨
        const profitData = projectData.map(item => item.netProfit);
        const profitColors = profitData.map(value => 
            value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
        );

        profitChart.data.labels = labels;
        profitChart.data.datasets = [{
            label: 'æ·¨æ”¶ç›Š',
            data: profitData,
            backgroundColor: profitColors,
            borderColor: profitColors.map(color => color.replace('0.8', '1')),
            borderWidth: 2
        }];
        profitChart.update();
    }

    // è¡¨æ ¼æ›´æ–°åŠŸèƒ½
    function updateTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        projectData.forEach((item, index) => {
            const row = document.createElement('tr');
            
            // ç‹€æ…‹åˆ¤æ–·
            let status, statusClass;
            if (item.executionRate >= 105) {
                status = 'è¶…å‰';
                statusClass = 'status-ahead';
            } else if (item.executionRate >= 95) {
                status = 'æ­£å¸¸';
                statusClass = 'status-normal';
            } else {
                status = 'è½å¾Œ';
                statusClass = 'status-behind';
            }

            // è¶¨å‹¢åˆ†æ
            let trend = 'â¡ï¸';
            if (previousData.length > 0) {
                const prevItem = previousData.find(prev => prev.name === item.name);
                if (prevItem) {
                    if (item.actual > prevItem.actual) trend = 'ğŸ“ˆ';
                    else if (item.actual < prevItem.actual) trend = 'ğŸ“‰';
                }
            }

            row.innerHTML = `
                <td><strong>${item.name}</strong></td>
                <td class="positive">${formatCurrency(item.actual)}</td>
                <td class="negative">${formatCurrency(item.expense)}</td>
                <td>${formatCurrency(item.planned)}</td>
                <td class="${item.netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(item.netProfit)}</td>
                <td class="${item.difference >= 0 ? 'positive' : 'negative'}">${formatCurrency(item.difference)}</td>
                <td>${item.executionRate.toFixed(1)}%</td>
                <td><span class="status-indicator ${statusClass}">${status}</span></td>
                <td>${trend}</td>
            `;
            
            tableBody.appendChild(row);
        });

        document.getElementById('dataCount').textContent = `(${projectData.length} å€‹é …ç›®)`;
    }

    // åŒ¯å‡ºåŠŸèƒ½
    function exportChart() {
        try {
            const canvas = document.getElementById('progressChart');
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `äºç£å·¥å‹™æ‰€é‡‘æµåˆ†æ_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = url;
            link.click();
            
            addLogEntry('ğŸ“Š åœ–è¡¨åŒ¯å‡ºæˆåŠŸ', 'success');
        } catch (error) {
            addLogEntry('âŒ åœ–è¡¨åŒ¯å‡ºå¤±æ•—: ' + error.message, 'error');
        }
    }

    function exportData() {
        try {
            let csvContent = "é …ç›®åç¨±,å¯¦éš›æ”¶å…¥,å¯¦éš›æ”¯å‡º,é ç®—é‡‘é¡,æ·¨æ”¶ç›Š,æ”¶æ”¯å·®ç•°,åŸ·è¡Œç‡,æœ€å¾Œæ›´æ–°\n";
            
            projectData.forEach(item => {
                csvContent += `"${item.name}",${item.actual},${item.expense},${item.planned},${item.netProfit},${item.difference},${item.executionRate.toFixed(2)},${item.lastUpdate}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `äºç£å·¥å‹™æ‰€é‡‘æµæ•¸æ“š_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addLogEntry('ğŸ“‹ æ•¸æ“šåŒ¯å‡ºæˆåŠŸ', 'success');
        } catch (error) {
            addLogEntry('âŒ æ•¸æ“šåŒ¯å‡ºå¤±æ•—: ' + error.message, 'error');
        }
    }

    // éŸ¿æ‡‰å¼è¨­è¨ˆæ”¯æ´
    function handleResize() {
        if (progressChart) progressChart.resize();
        if (differenceChart) differenceChart.resize();
        if (profitChart) profitChart.resize();
    }

    // äº‹ä»¶ç›£è½å™¨
    window.addEventListener('resize', handleResize);
    window.addEventListener('beforeunload', () => {
        stopAutoSync();
        if (countdownInterval) clearInterval(countdownInterval);
    });

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initSystem();
        
        // æ·»åŠ éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        manualSync();
                        break;
                    case 's':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'p':
                        e.preventDefault();
                        exportChart();
                        break;
                }
            }
        });
    });

</script>
</body>
</html>



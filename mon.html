<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶æ”¯ç®¡ç†ç³»çµ± - Google Sheets è‡ªå‹•é€£å‹•ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          margin: 0;
          padding: 20px;
          background-color: #f5f7fa;
      }
      .container {
          max-width: 1600px;
          margin: 0 auto;
      }
      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          margin-bottom: 30px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      }
      .header h1 {
          margin: 0 0 10px 0;
          font-size: 2.5em;
          font-weight: 300;
      }
      .connection-status {
          background: #fff3cd;
          border-left: 4px solid #ffc107;
          padding: 20px;
          margin: 20px 0;
          border-radius: 0 10px 10px 0;
      }
      .connection-status.connected {
          background: #d4edda;
          border-left-color: #28a745;
      }
      .connection-status.error {
          background: #f8d7da;
          border-left-color: #dc3545;
      }
      .setup-section {
          background: #e8f5e9;
          border-left: 4px solid #4caf50;
          padding: 20px;
          margin: 20px 0;
          border-radius: 0 10px 10px 0;
      }
      .setup-section h3 {
          color: #2e7d32;
          margin-top: 0;
      }
      .setup-section ol {
          margin: 10px 0;
          padding-left: 20px;
      }
      .setup-section li {
          margin: 8px 0;
      }
      .config-section {
          background: white;
          padding: 30px;
          border-radius: 15px;
          margin-bottom: 30px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      .config-section h2 {
          color: #2c3e50;
          margin-bottom: 20px;
      }
      .form-group {
          margin-bottom: 20px;
      }
      .form-group label {
          display: block;
          font-weight: 600;
          color: #495057;
          margin-bottom: 8px;
      }
      .form-group input,
      .form-group select {
          width: 100%;
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 14px;
          transition: border-color 0.3s ease;
          box-sizing: border-box;
      }
      .form-group input:focus,
      .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }
      .form-row {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
      }
      .btn {
          padding: 12px 24px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 500;
          transition: all 0.3s ease;
          font-size: 14px;
      }
      .btn-primary {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      .btn-success {
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
      }
      .btn-danger {
          background: linear-gradient(135deg, #dc3545, #c82333);
          color: white;
      }
      .btn-secondary {
          background: #6c757d;
          color: white;
      }
      .btn-group {
          display: flex;
          gap: 10px;
          margin-top: 20px;
      }
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }
      .stat-card {
          background: white;
          padding: 25px;
          border-radius: 15px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          text-align: center;
          position: relative;
          overflow: hidden;
      }
      .stat-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(135deg, #667eea, #764ba2);
      }
      .stat-card.income::before {
          background: linear-gradient(135deg, #28a745, #20c997);
      }
      .stat-card.expense::before {
          background: linear-gradient(135deg, #dc3545, #fd7e14);
      }
      .stat-card.balance::before {
          background: linear-gradient(135deg, #17a2b8, #20c997);
      }
      .stat-card h3 {
          font-size: 2.2em;
          margin: 0 0 10px 0;
          font-weight: 300;
          color: #2c3e50;
      }
      .stat-card p {
          margin: 0;
          color: #6c757d;
          font-weight: 500;
      }
      .data-table {
          background: white;
          border-radius: 15px;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          margin-bottom: 30px;
      }
      .table-header {
          background: linear-gradient(135deg, #f8f9fa, #e9ecef);
          padding: 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .table-header h3 {
          margin: 0;
          color: #2c3e50;
      }
      .table-wrapper {
          overflow-x: auto;
          max-height: 500px;
          overflow-y: auto;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          padding: 15px;
          text-align: left;
          border-bottom: 1px solid #e9ecef;
      }
      th {
          background: #f8f9fa;
          font-weight: 600;
          color: #495057;
          position: sticky;
          top: 0;
          z-index: 10;
      }
      tr:hover {
          background: #f8f9fa;
      }
      .amount {
          font-weight: 600;
          text-align: right;
      }
      .amount.positive {
          color: #28a745;
      }
      .amount.negative {
          color: #dc3545;
      }
      .empty-state {
          text-align: center;
          padding: 40px;
          color: #6c757d;
      }
      .chart-container {
          background: white;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          margin-bottom: 30px;
          height: 400px;
          position: relative;
      }
      .chart-title {
          text-align: center;
          font-size: 1.3em;
          font-weight: 600;
          color: #2c3e50;
          margin-bottom: 20px;
      }
      .tabs {
          display: flex;
          background: white;
          border-radius: 15px;
          margin-bottom: 30px;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      .tab {
          flex: 1;
          padding: 20px;
          text-align: center;
          cursor: pointer;
          border: none;
          background: transparent;
          font-weight: 600;
          font-size: 16px;
          transition: all 0.3s ease;
          position: relative;
      }
      .tab.active {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }
      .tab:not(.active):hover {
          background: #f8f9fa;
      }
      .tab-content {
          display: none;
      }
      .tab-content.active {
          display: block;
      }
      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #3498db;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      .refresh-info {
          background: #e3f2fd;
          padding: 15px;
          border-radius: 10px;
          margin: 20px 0;
          text-align: center;
      }
      .last-update {
          color: #666;
          font-size: 14px;
          margin-top: 10px;
      }
      .url-converter {
          background: #fff3e0;
          padding: 15px;
          border-radius: 10px;
          margin: 15px 0;
          font-size: 14px;
      }
      @media (max-width: 768px) {
          .form-row {
              grid-template-columns: 1fr;
          }
          .stats-grid {
              grid-template-columns: 1fr;
          }
          .btn-group {
              flex-direction: column;
          }
          .table-wrapper {
              max-height: 300px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ’° æ”¶æ”¯ç®¡ç†ç³»çµ±</h1>
          <p>Google Sheets è‡ªå‹•é€£å‹•ç‰ˆ</p>
      </div>

      <div id="connectionStatus" class="connection-status connected">
          <h3>ğŸ”— é€£ç·šç‹€æ…‹</h3>
          <p id="statusText">âœ… å·²è‡ªå‹•è¨­å®šæ‚¨çš„ Google Sheets é€£çµ</p>
          <div class="last-update" id="lastUpdate"></div>
      </div>

      <div class="setup-section">
          <h3>ğŸ“‹ ç³»çµ±èªªæ˜</h3>
          <ul>
              <li>ç³»çµ±å·²è‡ªå‹•è¨­å®šæ‚¨æä¾›çš„ Google Sheets é€£çµ</li>
              <li>è³‡æ–™æœƒæ¯ 30 åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡</li>
              <li>æ‚¨å¯ä»¥éš¨æ™‚é»æ“Šã€Œæ‰‹å‹•æ›´æ–°ã€æŒ‰éˆ•ç«‹å³åˆ·æ–°è³‡æ–™</li>
              <li>å¦‚éœ€ä¿®æ”¹é€£çµæˆ–æ›´æ–°é »ç‡ï¼Œè«‹åˆ°ã€Œè¨­å®šã€åˆ†é </li>
          </ul>
      </div>

      <div class="tabs">
          <button class="tab active" onclick="switchTab('overview')">ğŸ“Š ç¸½è¦½</button>
          <button class="tab" onclick="switchTab('income')">ğŸ’° æ”¶å…¥æ˜ç´°</button>
          <button class="tab" onclick="switchTab('expense')">ğŸ’¸ æ”¯å‡ºæ˜ç´°</button>
          <button class="tab" onclick="switchTab('setup')">âš™ï¸ è¨­å®š</button>
      </div>

      <!-- ç¸½è¦½é é¢ -->
      <div class="tab-content active" id="overview">
          <div class="stats-grid">
              <div class="stat-card income">
                  <h3 id="totalIncome">NT$ 0</h3>
                  <p>ğŸ’° ç¸½æ”¶å…¥</p>
              </div>
              <div class="stat-card expense">
                  <h3 id="totalExpense">NT$ 0</h3>
                  <p>ğŸ’¸ ç¸½æ”¯å‡º</p>
              </div>
              <div class="stat-card balance">
                  <h3 id="netBalance">NT$ 0</h3>
                  <p>ğŸ’ æ·¨é¤˜é¡</p>
              </div>
              <div class="stat-card">
                  <h3 id="totalTransactions">0</h3>
                  <p>ğŸ“Š ç¸½äº¤æ˜“æ•¸</p>
              </div>
          </div>

          <div class="chart-container">
              <div class="chart-title">ğŸ“Š æ”¶æ”¯å°æ¯”åœ–è¡¨</div>
              <canvas id="overviewChart"></canvas>
          </div>

          <div class="refresh-info">
              <button class="btn btn-success" onclick="refreshData()">
                  <span id="refreshLoadingIcon"></span>
                  ğŸ”„ æ‰‹å‹•æ›´æ–°è³‡æ–™
              </button>
              <p>ä¸‹æ¬¡è‡ªå‹•æ›´æ–°ï¼š<span id="nextUpdateTime">-</span></p>
          </div>
      </div>

      <!-- æ”¶å…¥æ˜ç´°é é¢ -->
      <div class="tab-content" id="income">
          <div class="data-table">
              <div class="table-header">
                  <h3>ğŸ’° æ”¶å…¥æ˜ç´°</h3>
                  <button class="btn btn-primary btn-sm" onclick="exportData('income')">ğŸ“¤ åŒ¯å‡º</button>
              </div>
              <div class="table-wrapper">
                  <table id="incomeTable">
                      <thead>
                          <tr>
                              <th>æ—¥æœŸ</th>
                              <th>æ”¶å…¥ä¾†æº</th>
                              <th>é‡‘é¡</th>
                              <th>å‚™è¨»</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td colspan="4" class="empty-state">
                                  <div class="loading"></div>
                                  <p>æ­£åœ¨è¼‰å…¥æ”¶å…¥è³‡æ–™...</p>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- æ”¯å‡ºæ˜ç´°é é¢ -->
      <div class="tab-content" id="expense">
          <div class="data-table">
              <div class="table-header">
                  <h3>ğŸ’¸ æ”¯å‡ºæ˜ç´°</h3>
                  <button class="btn btn-primary btn-sm" onclick="exportData('expense')">ğŸ“¤ åŒ¯å‡º</button>
              </div>
              <div class="table-wrapper">
                  <table id="expenseTable">
                      <thead>
                          <tr>
                              <th>é …æ¬¡</th>
                              <th>æ‰¿åŒ…å» å•†</th>
                              <th>æ‰¿ä½œé …ç›®</th>
                              <th>ç™¼ç¥¨é‡‘é¡</th>
                              <th>å‚™è¨»</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td colspan="5" class="empty-state">
                                  <div class="loading"></div>
                                  <p>æ­£åœ¨è¼‰å…¥æ”¯å‡ºè³‡æ–™...</p>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- è¨­å®šé é¢ -->
      <div class="tab-content" id="setup">
          <div class="config-section">
              <h2>âš™ï¸ Google Sheets é€£çµè¨­å®š</h2>
              <div class="url-converter">
                  <strong>ğŸ“ é€£çµè½‰æ›èªªæ˜ï¼š</strong><br>
                  ç³»çµ±å·²è‡ªå‹•å°‡æ‚¨çš„ Google Sheets å…¬é–‹é€£çµè½‰æ›ç‚º CSV æ ¼å¼ä»¥ä¾¿è®€å–è³‡æ–™
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>æ”¶å…¥è¡¨ CSV é€£çµ</label>
                      <input type="url" id="incomeSheetUrl" readonly
                             value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRqZ0tdZx0sH-MxUuT7U2nysa7RXpe5WyAHOrJCAlR4pfFdTht5LgTTIh0aYLkAFjBVJQzZD_MRvVd4/pub?output=csv">
                  </div>
                  <div class="form-group">
                      <label>æ”¯å‡ºè¡¨ CSV é€£çµ</label>
                      <input type="url" id="expenseSheetUrl" readonly
                             value="https://docs.google.com/spreadsheets/d/e/2PACX-1vSx7YV5A3olHd1VmtC1Udhc6K2FMnEY2naun8OTuEnGCA640I_e8yDF-59pCLk5vm24v4uDKDvQgi2N/pub?output=csv">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>è‡ªå‹•æ›´æ–°é–“éš”ï¼ˆåˆ†é˜ï¼‰</label>
                      <select id="refreshInterval">
                          <option value="0">æ‰‹å‹•æ›´æ–°</option>
                          <option value="1">1 åˆ†é˜</option>
                          <option value="5">5 åˆ†é˜</option>
                          <option value="10">10 åˆ†é˜</option>
                          <option value="30" selected>30 åˆ†é˜</option>
                          <option value="60">60 åˆ†é˜</option>
                      </select>
                  </div>
              </div>
              <div class="btn-group">
                  <button class="btn btn-primary" onclick="connectAndLoadData()">
                      <span id="loadingIcon"></span>
                      ğŸ”— é‡æ–°è¼‰å…¥è³‡æ–™
                  </button>
                  <button class="btn btn-success" onclick="refreshData()">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
                  <button class="btn btn-secondary" onclick="saveConfig()">ğŸ’¾ å„²å­˜è¨­å®š</button>
              </div>
          </div>

          <div class="refresh-info">
              <h4>ğŸ”„ è‡ªå‹•æ›´æ–°è³‡è¨Š</h4>
              <p>ç³»çµ±æœƒæ ¹æ“šæ‚¨è¨­å®šçš„é–“éš”è‡ªå‹•å¾ Google Sheets æ›´æ–°è³‡æ–™</p>
              <p>ä¸‹æ¬¡æ›´æ–°æ™‚é–“ï¼š<span id="nextUpdateTimeSetup">-</span></p>
          </div>
      </div>
  </div>

  <script>
      // è³‡æ–™å„²å­˜
      let incomeData = [];
      let expenseData = [];
      let chart = null;
      let refreshTimer = null;
      let isLoading = false;

      // é è¨­çš„ Google Sheets CSV é€£çµ
      const DEFAULT_INCOME_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRqZ0tdZx0sH-MxUuT7U2nysa7RXpe5WyAHOrJCAlR4pfFdTht5LgTTIh0aYLkAFjBVJQzZD_MRvVd4/pub?output=csv';
      const DEFAULT_EXPENSE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSx7YV5A3olHd1VmtC1Udhc6K2FMnEY2naun8OTuEnGCA640I_e8yDF-59pCLk5vm24v4uDKDvQgi2N/pub?output=csv';

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
          initChart();
          
          // è‡ªå‹•è¼‰å…¥è³‡æ–™
          setTimeout(() => {
              connectAndLoadData();
          }, 1000);
      });

      // æ ¼å¼åŒ–é‡‘é¡
      function formatAmount(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0
          }).format(amount);
      }

      // æ›´æ–°é€£ç·šç‹€æ…‹
      function updateConnectionStatus(status, message) {
          const statusElement = document.getElementById('connectionStatus');
          const statusText = document.getElementById('statusText');
          
          statusElement.className = `connection-status ${status}`;
          statusText.textContent = message;
          
          if (status === 'connected') {
              const lastUpdate = document.getElementById('lastUpdate');
              lastUpdate.textContent = `æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleString('zh-TW')}`;
          }
      }

      // è§£æ CSV è³‡æ–™
      function parseCSV(csvText) {
          const lines = csvText.trim().split('\n');
          if (lines.length < 2) return [];
          
          const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
          const data = [];
          
          for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue;
              
              const values = [];
              let current = '';
              let inQuotes = false;
              
              for (let j = 0; j < line.length; j++) {
                  const char = line[j];
                  if (char === '"') {
                      inQuotes = !inQuotes;
                  } else if (char === ',' && !inQuotes) {
                      values.push(current.replace(/"/g, '').trim());
                      current = '';
                  } else {
                      current += char;
                  }
              }
              values.push(current.replace(/"/g, '').trim());
              
              if (values.length >= headers.length && values.some(v => v)) {
                  const row = {};
                  headers.forEach((header, index) => {
                      row[header] = values[index] || '';
                  });
                  data.push(row);
              }
          }
          
          return data;
      }

      // è¼‰å…¥æ”¶å…¥è³‡æ–™
      async function loadIncomeData(url) {
          try {
              const response = await fetch(url + '&timestamp=' + Date.now());
              if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥æ”¶å…¥è³‡æ–™');
              
              const csvText = await response.text();
              const rawData = parseCSV(csvText);
              
              incomeData = rawData.map((row, index) => ({
                  id: index + 1,
                  date: row['æ—¥æœŸ'] || row['Date'] || row['date'] || '',
                  source: row['æ”¶å…¥ä¾†æº'] || row['Source'] || row['ä¾†æº'] || row['source'] || '',
                  amount: parseFloat((row['é‡‘é¡'] || row['Amount'] || row['amount'] || '0').toString().replace(/[^0-9.-]/g, '')) || 0,
                  notes: row['å‚™è¨»'] || row['Notes'] || row['Note'] || row['notes'] || ''
              })).filter(item => item.amount > 0 || item.source);
              
              return true;
          } catch (error) {
              console.error('è¼‰å…¥æ”¶å…¥è³‡æ–™å¤±æ•—:', error);
              return false;
          }
      }

      // è¼‰å…¥æ”¯å‡ºè³‡æ–™
      async function loadExpenseData(url) {
          try {
              const response = await fetch(url + '&timestamp=' + Date.now());
              if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥æ”¯å‡ºè³‡æ–™');
              
              const csvText = await response.text();
              const rawData = parseCSV(csvText);
              
              expenseData = rawData.map((row, index) => ({
                  id: index + 1,
                  itemNo: row['é …æ¬¡'] || row['Item No'] || row['ç·¨è™Ÿ'] || row['itemNo'] || '',
                  vendor: row['æ‰¿åŒ…å» å•†'] || row['Vendor'] || row['å» å•†'] || row['vendor'] || '',
                  item: row['æ‰¿ä½œé …ç›®'] || row['Item'] || row['é …ç›®'] || row['item'] || '',
                  amount: parseFloat((row['ç™¼ç¥¨é‡‘é¡'] || row['Amount'] || row['é‡‘é¡'] || row['amount'] || '0').toString().replace(/[^0-9.-]/g, '')) || 0,
                  notes: row['å‚™è¨»'] || row['Notes'] || row['Note'] || row['notes'] || ''
              })).filter(item => item.amount > 0 || item.vendor || item.item);
              
              return true;
          } catch (error) {
              console.error('è¼‰å…¥æ”¯å‡ºè³‡æ–™å¤±æ•—:', error);
              return false;
          }
      }

      // é€£æ¥ä¸¦è¼‰å…¥è³‡æ–™
      async function connectAndLoadData() {
          if (isLoading) return;
          
          isLoading = true;
          const loadingIcon = document.getElementById('loadingIcon');
          const refreshLoadingIcon = document.getElementById('refreshLoadingIcon');
          
          if (loadingIcon) loadingIcon.innerHTML = '<span class="loading"></span> ';
          if (refreshLoadingIcon) refreshLoadingIcon.innerHTML = '<span class="loading"></span> ';
          
          updateConnectionStatus('', 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™...');
          
          try {
              const incomeSuccess = await loadIncomeData(DEFAULT_INCOME_URL);
              const expenseSuccess = await loadExpenseData(DEFAULT_EXPENSE_URL);
              
              if (incomeSuccess && expenseSuccess) {
                  updateConnectionStatus('connected', `âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼æ”¶å…¥ ${incomeData.length} ç­†ï¼Œæ”¯å‡º ${expenseData.length} ç­†`);
                  updateStatistics();
                  updateAllTables();
                  updateChart();
                  setupAutoRefresh();
              } else if (incomeSuccess || expenseSuccess) {
                  updateConnectionStatus('connected', 'âš ï¸ éƒ¨åˆ†è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œè«‹æª¢æŸ¥ Google Sheets è¨­å®š');
                  updateStatistics();
                  updateAllTables();
                  updateChart();
              } else {
                  updateConnectionStatus('error', 'âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google Sheets æ˜¯å¦å·²å…¬é–‹ç™¼å¸ƒ');
              }
          } catch (error) {
              updateConnectionStatus('error', `âŒ é€£æ¥å¤±æ•—ï¼š${error.message}`);
          }
          
          isLoading = false;
          if (loadingIcon) loadingIcon.innerHTML = '';
          if (refreshLoadingIcon) refreshLoadingIcon.innerHTML = '';
      }

      // æ‰‹å‹•æ›´æ–°è³‡æ–™
      function refreshData() {
          connectAndLoadData();
      }

      // è¨­å®šè‡ªå‹•æ›´æ–°
      function setupAutoRefresh() {
          if (refreshTimer) {
              clearInterval(refreshTimer);
          }
          
          const interval = parseInt(document.getElementById('refreshInterval').value);
          if (interval > 0) {
              refreshTimer = setInterval(() => {
                  connectAndLoadData();
              }, interval * 60 * 1000);
              
              updateNextUpdateTime(interval);
          }
      }

      // æ›´æ–°ä¸‹æ¬¡æ›´æ–°æ™‚é–“é¡¯ç¤º
      function updateNextUpdateTime(intervalMinutes) {
          const nextUpdate = new Date();
          nextUpdate.setMinutes(nextUpdate.getMinutes() + intervalMinutes);
          const timeString = nextUpdate.toLocaleString('zh-TW');
          
          const nextUpdateElement = document.getElementById('nextUpdateTime');
          const nextUpdateSetupElement = document.getElementById('nextUpdateTimeSetup');
          
          if (nextUpdateElement) nextUpdateElement.textContent = timeString;
          if (nextUpdateSetupElement) nextUpdateSetupElement.textContent = timeString;
      }

      // å„²å­˜è¨­å®š
      function saveConfig() {
          const interval = document.getElementById('refreshInterval').value;
          localStorage.setItem('refreshInterval', interval);
          setupAutoRefresh();
          alert('è¨­å®šå·²å„²å­˜ï¼');
      }

      // æ›´æ–°çµ±è¨ˆè³‡æ–™
      function updateStatistics() {
          const totalIncome = incomeData.reduce((sum, item) => sum + item.amount, 0);
          const totalExpense = expenseData.reduce((sum, item) => sum + item.amount, 0);
          const netBalance = totalIncome - totalExpense;
          const totalTransactions = incomeData.length + expenseData.length;

          document.getElementById('totalIncome').textContent = formatAmount(totalIncome);
          document.getElementById('totalExpense').textContent = formatAmount(totalExpense);
          document.getElementById('netBalance').textContent = formatAmount(netBalance);
          document.getElementById('totalTransactions').textContent = totalTransactions;
      }

      // åˆ‡æ›åˆ†é 
      function switchTab(tabName) {
          // æ›´æ–°åˆ†é æŒ‰éˆ•
          document.querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
          });
          event.target.classList.add('active');
          
          // æ›´æ–°åˆ†é å…§å®¹
          document.querySelectorAll('.tab-content').forEach(content =>
